<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bifost - Catatan Kelas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- =================================================================
    ==                          KODE CSS LENGKAP                        ==
    ================================================================== -->
    <style>
        :root {
            --bg-color: #0d1117; --card-color: #161b22; --primary-color: #21262d; --accent-color: #58a6ff;
            --danger-color: #f85149; --text-color: #c9d1d9; --text-muted: #8b949e; --border-color: #30363d;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --header-height: 60px; --toolbar-height: 50px; --footer-height: 60px; --ruler-size: 25px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-color); }
        body { font-family: var(--font-family); color: var(--text-color); line-height: 1.6; }

        .page-fade-in { animation: fadeIn 0.3s ease; }
        .page-fade-out { animation: fadeOut 0.25s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .auth-container { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; background: linear-gradient(135deg, #0d1117, #1b212c); }
        .form-box { width: 100%; max-width: 400px; background: rgba(22, 27, 34, 0.85); padding: 3rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); }
        .auth-logo { display: block; width: 80px; height: 80px; margin: 0 auto 1.5rem auto; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); padding: 5px; background-color: var(--primary-color); }
        .form-box h2 { text-align: center; margin-bottom: 0.5rem; color: #fff; font-weight: 600; }
        .form-subtitle { text-align: center; margin-bottom: 2rem; color: var(--text-muted); }
        .input-group { margin-bottom: 1.5rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input-group input { width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; transition: all 0.2s ease-in-out; }
        .input-group input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.25); }
        .auth-button { width: 100%; padding: 0.8rem; border: none; border-radius: 8px; background-color: var(--accent-color); color: var(--bg-color); font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; }
        .auth-button:hover { background-color: #80baff; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3); }
        .form-footer { text-align: center; margin-top: 1.5rem; color: var(--text-muted); }
        .form-footer a { color: var(--accent-color); text-decoration: none; font-weight: 500; transition: color 0.2s; cursor: pointer; }
        .form-footer a:hover { color: #80baff; }

        .app-container, .auth-wrapper { display: none; }
        .app-container { flex-direction: column; height: 100vh; }
        .app-page { display: flex; flex-direction: column; height: 100%; position: absolute; top: 0; left: 0; width: 100%; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateY(10px); pointer-events: none; }
        .app-page.active-page { opacity: 1; transform: translateY(0); pointer-events: auto; }

        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 0 1.5rem; background-color: var(--card-color); border-bottom: 1px solid var(--border-color); flex-shrink: 0; height: var(--header-height); }
        .header-logo-group { display: flex; align-items: center; gap: 1rem; }
        .header-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .app-header h1 { font-size: 1.25rem; font-weight: 500; }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .header-actions .header-btn { background: none; border: none; color: var(--text-muted); font-size: 1.25rem; cursor: pointer; padding: 0.5rem; transition: color 0.2s, background-color 0.2s; border-radius: 50%; }
        .header-actions .header-btn:hover, .header-actions .header-btn.active { color: var(--accent-color); background-color: var(--primary-color); }
        
        .editor-toolbar { display: flex; flex-wrap: nowrap; gap: 5px; padding: 0.5rem 1.5rem; background-color: var(--primary-color); border-bottom: 1px solid var(--border-color); flex-shrink: 0; height: var(--toolbar-height); align-items: center; overflow-x: auto; scrollbar-width: thin; }
        .editor-wrapper { position: relative; height: calc(100vh - var(--header-height) - var(--toolbar-height) - var(--footer-height)); overflow: auto; background-color: var(--bg-color); }
        .ruler { position: absolute; background-color: var(--primary-color); z-index: 1; overflow: hidden; user-select: none; }
        .ruler.horizontal { top: 0; left: var(--ruler-size); width: calc(100% - var(--ruler-size)); height: var(--ruler-size); border-bottom: 1px solid var(--border-color); }
        .ruler.vertical { top: var(--ruler-size); left: 0; width: var(--ruler-size); height: calc(100% - var(--ruler-size)); border-right: 1px solid var(--border-color); }
        .ruler-mark { position: absolute; background-color: var(--border-color); }
        .ruler.horizontal .ruler-mark { top: 0; width: 1px; }
        .ruler.vertical .ruler-mark { left: 0; height: 1px; }
        .ruler-number { position: absolute; font-size: 10px; color: var(--text-muted); }
        .ruler.horizontal .ruler-number { transform: translateX(-50%); }
        .ruler.vertical .ruler-number { transform: translateY(-50%) rotate(-90deg); left: 4px; transform-origin: center; width: 100%; text-align: right; padding-right: 5px; }
        .note-editor { padding: 1rem; outline: none; font-size: 1rem; overflow-wrap: break-word; word-break: break-word; min-height: 100%; transition: padding 0.3s ease; }
        .editor-wrapper.ruler-active .note-editor { padding: 1.5rem; margin: var(--ruler-size); margin-bottom: 0; margin-top: 0; height: auto; background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 4px; }
        .note-editor:empty:before { content: "Mulai menulis di sini..."; color: var(--text-muted); pointer-events: none; }
        
        #server-editor-wrapper:not(.ruler-active) .ruler { display: none; }
        #server-note-content:not([contenteditable="true"]) { padding: 1.5rem; user-select: text; -webkit-user-select: text; cursor: text; }
        #server-note-content:not([contenteditable="true"]):empty::before { content: "Belum ada catatan dari admin."; }

        .toolbar-separator { width: 1px; height: 25px; background-color: var(--border-color); margin: 0 8px; flex-shrink: 0; }
        .editor-toolbar button, .editor-toolbar .color-picker-wrapper { height: 35px; min-width: 40px; padding: 0 10px; border: none; background-color: transparent; color: var(--text-color); font-size: 16px; cursor: pointer; border-radius: 4px; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; flex-shrink: 0; position: relative; }
        .editor-toolbar button:hover, .editor-toolbar .color-picker-wrapper:hover { background-color: var(--border-color); }
        .editor-toolbar button.active { background-color: var(--accent-color); color: var(--bg-color); }
        .color-picker-wrapper input[type="color"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        .note-editor a { color: var(--accent-color); text-decoration: underline; }
        .note-editor img { max-width: 100%; height: auto; display: block; margin: 10px 0; border-radius: 6px; }
        .note-editor ol, .note-editor ul, .note-editor blockquote { padding-left: 40px; }
        .note-editor blockquote { border-left: 3px solid var(--accent-color); color: var(--text-muted); margin: 1em 0; padding: 0.5em 1em; }
        .note-editor [style*="text-align: center;"] { margin: 0 auto; }
        .note-editor [style*="text-align: right;"] { margin-left: auto; }

        .task-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; }
        .task-item .task-item-checkbox { user-select: none; -webkit-user-select: none; }
        .task-item-checkbox { width: 18px; height: 18px; background-color: transparent; border: 2px solid var(--text-muted); border-radius: 3px; cursor: pointer; flex-shrink: 0; margin-top: 4px; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; }
        .task-item-checkbox .fas { font-size: 12px; color: #fff; transform: scale(0); transition: transform 0.2s ease; }
        .task-item-content { flex-grow: 1; outline: none; transition: opacity 0.3s; }
        .task-item.completed { opacity: 0.5; }
        .task-item.completed .task-item-content { text-decoration: line-through; }
        .task-item.completed .task-item-checkbox { background-color: var(--accent-color); border-color: var(--accent-color); }
        .task-item.completed .task-item-checkbox .fas { transform: scale(1); }

        #notes-list-page .app-header { display: grid; grid-template-columns: auto 1fr auto; gap: 1rem; align-items: center; }
        #notes-list-page .header-logo-group { grid-column: 1 / 2; }
        #notes-list-page .header-actions { grid-column: 3 / 4; }
        .header-search-wrapper { position: relative; grid-column: 2 / 3; max-width: 500px; margin: 0 auto; width: 100%; }
        .header-search-wrapper i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; z-index: 1; }
        .header-search { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); padding: 0.6rem 1rem 0.6rem 2.75rem; width: 100%; transition: all 0.3s ease-in-out; font-size: 0.9rem; }
        .header-search:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.25); background-color: var(--primary-color); }
        
        .list-main { padding: 1rem 1.5rem; overflow-y: auto; }
        .app-footer { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; height: var(--footer-height); background-color: var(--card-color); border-top: 1px solid var(--border-color); flex-shrink: 0; z-index: 100; }
        .nav-item { flex-grow: 1; background: none; border: none; color: var(--text-muted); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: color 0.2s ease; gap: 4px; font-size: 0.7rem; }
        .nav-item i { font-size: 1.2rem; }
        .nav-item.active, .nav-item:hover { color: var(--accent-color); }
        
        .note-item-selector { padding: 1rem; background-color: var(--card-color); border-left: 4px solid transparent; margin-bottom: 0.75rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; overflow: hidden; border-radius: 6px; }
        .note-item-selector:hover { background-color: var(--primary-color); }
        .note-item-selector.active { background-color: var(--primary-color); border-left-color: var(--accent-color); }
        .note-item-selector .title { font-weight: 500; overflow-wrap: break-word; }
        mark { background-color: var(--accent-color); color: var(--bg-color); border-radius: 3px; padding: 2px 4px; }
        .delete-note-btn { background: none; border: none; color: var(--text-muted); font-size: 1rem; cursor: pointer; transition: color 0.2s; padding: 0.5rem; }
        .delete-note-btn:hover { color: var(--danger-color); }
        .notes-filtered .note-item-selector.has-completed-tasks { display: none; }

        /* === LINK POPOVER === */
        .editor-popover {
            position: absolute; background-color: var(--primary-color); border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 8px;
            display: flex; gap: 8px; z-index: 1001; transition: opacity 0.2s, transform 0.2s;
        }
        .editor-popover input {
            background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color);
            border-radius: 4px; padding: 6px 10px; outline: none; width: 250px;
        }
        .editor-popover input:focus { border-color: var(--accent-color); }
        .editor-popover button {
            background-color: transparent; border: none; color: var(--text-color); width: 35px;
            height: 35px; font-size: 1rem; cursor: pointer; border-radius: 4px; transition: background-color 0.2s;
        }
        .editor-popover button:hover { background-color: var(--border-color); }
        #link-save-btn:hover { color: var(--accent-color); }
        #link-remove-btn:hover { color: var(--danger-color); }

        .loading-overlay, .custom-dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
        .loading-spinner { border: 5px solid rgba(255, 255, 255, 0.2); border-top: 5px solid var(--accent-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: var(--card-color); color: var(--text-color); padding: 1rem 1.5rem; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideInRight 0.3s ease, fadeOutToast 0.5s ease 2.5s forwards; }
        .toast.error { border-left: 4px solid var(--danger-color); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: scale(0.9); } }

        .custom-dialog-box { background: var(--card-color); padding: 2rem; border-radius: 10px; text-align: center; max-width: 350px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.4); animation: fadeIn 0.3s; }
        .custom-dialog-box h3 { margin-bottom: 0.5rem; font-size: 1.25rem; color: #fff; }
        .custom-dialog-box p { margin-bottom: 1.5rem; color: var(--text-muted); }
        .dialog-buttons { display: flex; gap: 1rem; }
        .dialog-btn { flex: 1; padding: 0.7rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .dialog-btn.cancel { background-color: var(--primary-color); color: var(--text-color); }
        .dialog-btn.cancel:hover { background-color: var(--border-color); }
        .dialog-btn.ok { background-color: var(--danger-color); color: #fff; }
        .dialog-btn.ok:hover { background-color: #d63c34; }
    </style>
</head>
<body class="page-fade-in">

    <!-- Auth, App, dan elemen HTML lainnya -->
    <div id="auth-wrapper" class="auth-wrapper" style="display: block;"><div class="auth-container"><div id="login-view" class="form-box"><img src="img/bifost.png" alt="Logo Bifost" class="auth-logo"><h2>Selamat Datang Kembali</h2><p class="form-subtitle">Silakan masuk untuk melanjutkan</p><form id="login-form"><div class="input-group"><label for="username">User ID</label><input type="text" id="username" required="" placeholder="Masukkan User ID Anda"></div><div class="input-group"><label for="password">Password</label><input type="password" id="password" required="" placeholder="••••••••"></div><button type="submit" class="auth-button">Login</button></form><p class="form-footer">Belum punya akun? <a id="show-register">Buat akun baru</a></p></div><div id="register-view" class="form-box" style="display: none;"><img src="img/bifost.png" alt="Logo Bifost" class="auth-logo"><h2>Buat Akun Baru</h2><p class="form-subtitle">Bergabung dengan Kelas XII-B (Bifost)</p><form id="register-form"><div class="input-group"><label for="new-username">User ID</label><input type="text" id="new-username" required="" placeholder="Contoh: user123"></div><div class="input-group"><label for="new-password">Password</label><input type="password" id="new-password" required="" placeholder="••••••••"></div><button type="submit" class="auth-button">Buat Akun</button></form><p class="form-footer">Sudah punya akun? <a id="show-login">Login di sini</a></p></div></div></div>
    <div id="app-container" class="app-container" style="display: none;"><div id="personal-notes-page" class="app-page active-page"><header class="app-header"><div class="header-logo-group"><img src="img/bifost.png" class="header-logo"><h1>Catatan Pribadi</h1></div><div class="header-actions"><button id="btn-daily-note" class="header-btn" title="Buka Catatan Hari Ini"><i class="fas fa-calendar-day"></i></button><button id="btn-new-note" class="header-btn" title="Catatan Baru"><i class="fas fa-plus"></i></button><button id="save-note-btn" class="header-btn" title="Simpan Catatan"><i class="fas fa-save"></i></button></div></header><div id="personal-toolbar" class="editor-toolbar"></div><main class="editor-main"><div id="personal-editor-wrapper" class="editor-wrapper ruler-active"><div class="ruler horizontal"></div><div class="ruler vertical"></div><div id="note-editor" class="note-editor" contenteditable="true"></div></div></main></div><div id="server-notes-page" class="app-page"><header class="app-header"><div class="header-logo-group"><img src="img/bifost.png" class="header-logo"><h1>Pengumuman Harian</h1></div><div id="server-header-actions" class="header-actions" style="display:none;"><button id="save-server-note-btn" class="header-btn" title="Simpan Catatan Server"><i class="fas fa-save"></i></button></div></header><div id="server-toolbar" class="editor-toolbar" style="display:none;"></div><main class="editor-main"><div id="server-editor-wrapper" class="editor-wrapper"><div class="ruler horizontal"></div><div class="ruler vertical"></div><div id="server-note-content" class="note-editor" contenteditable="false"></div></div></main></div><div id="notes-list-page" class="app-page"><header class="app-header"><div class="header-logo-group"><img src="img/bifost.png" class="header-logo"><h1>Daftar Catatan</h1></div><div class="header-search-wrapper"><i class="fas fa-search"></i><input type="search" id="search-notes-input" class="header-search" placeholder="Cari di dalam catatan..."></div><div class="header-actions"><button id="task-filter-btn" class="header-btn" title="Filter Tugas Belum Selesai"><i class="fas fa-filter"></i></button></div></header><main id="notes-list-container" class="list-main"></main></div><footer class="app-footer"><button class="nav-item active" data-page="personal-notes-page"><i class="fas fa-user-pen"></i><span>Pribadi</span></button><button class="nav-item" data-page="notes-list-page"><i class="fas fa-book"></i><span>Daftar</span></button><button class="nav-item" data-page="server-notes-page"><i class="fas fa-tower-broadcast"></i><span>Pengumuman</span></button><button id="logout-btn-nav" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button></footer></div>
    
    <!-- Popover untuk Link Editor -->
    <div id="link-popover" class="editor-popover" style="display: none;">
        <input type="text" id="link-url-input" placeholder="Masukkan atau tempel URL">
        <button id="link-save-btn" title="Simpan"><i class="fas fa-check"></i></button>
        <button id="link-remove-btn" title="Hapus Tautan"><i class="fas fa-unlink"></i></button>
    </div>

    <div id="custom-confirm-dialog" class="custom-dialog-overlay"></div><div id="loading-overlay" class="loading-overlay"><div class="loading-spinner"></div></div><div id="toast-container"></div><input type="file" id="image-input" accept="image/*" style="display: none;"><input type="file" id="server-image-input" accept="image/*" style="display: none;">

    <!-- =================================================================
    ==                       KODE JAVASCRIPT LENGKAP                    ==
    ================================================================== -->
    <script>
    //<![CDATA[
    
    // ================== KODE DARI: api.js ==================
    const MASTER_KEY = '$2a$10$okx9jFMKaWaF4KfhN9ebR.n35jpcrw2UL4sEu.OOTYQTdg/mQb.K6';
    const ACCESS_KEY = '$2a$10$7pRgxTu4LqvfRNJpqPLZ0OILN3TwWgTB7tuA0KGUO3nKnBFFPIJzW';
    const DATA_USER_BIN_ID = '687df0042d1dfe3c2c759ad6';
    const USER_NOTES_BIN_ID = '687df13fd1981e22d1897e69';
    const SERVER_NOTES_BIN_ID = '6891ae4e7b4b8670d8ad885d';
    const JSONBIN_API_URL = 'https://api.jsonbin.io/v3/b/';

    const loadingOverlay = document.getElementById('loading-overlay');
    const showLoading = (show) => { if (loadingOverlay) loadingOverlay.style.display = show ? 'flex' : 'none'; };

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container'); if (!container) return;
        const toast = document.createElement('div'); toast.className = `toast ${type}`;
        toast.textContent = message; container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function showConfirm(title, message) {
        return new Promise((resolve) => {
            const dialogContainer = document.getElementById('custom-confirm-dialog');
            dialogContainer.style.display = 'flex';
            dialogContainer.innerHTML = `<div class="custom-dialog-box"><h3>${title}</h3><p>${message}</p><div class="dialog-buttons"><button class="dialog-btn cancel">Batal</button><button class="dialog-btn ok">Ya</button></div></div>`;
            const closeDialog = (value) => { dialogContainer.style.display = 'none'; resolve(value); };
            dialogContainer.querySelector('.ok').addEventListener('click', () => closeDialog(true));
            dialogContainer.querySelector('.cancel').addEventListener('click', () => closeDialog(false));
        });
    }

    async function readBin(binId) {
        showLoading(true);
        try {
            const response = await fetch(`${JSONBIN_API_URL}${binId}/latest`, { headers: { 'X-Master-Key': MASTER_KEY, 'X-Access-Key': ACCESS_KEY } });
            if (response.status === 404) return {};
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return (await response.json()).record || {};
        } catch (error) { showToast(`Gagal membaca data: ${error.message}`, 'error'); return {}; } finally { showLoading(false); }
    }

    async function updateBin(binId, data) {
        showLoading(true);
        try {
            const response = await fetch(`${JSONBIN_API_URL}${binId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY }, body: JSON.stringify(data) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || `HTTP ${response.status}`); }
            return await response.json();
        } catch (error) { showToast(`Gagal menyimpan data: ${error.message}`, 'error'); return null; } finally { showLoading(false); }
    }

    // ================== KODE DARI: notes.js ==================
    let currentEditingNoteId = null;
    let userNotesCache = [];
    let loggedInUser = null;
    
    class EditorHistory {
        constructor(editorElement) { this.editor = editorElement; this.undoStack = []; this.redoStack = []; this.init(); }
        init() { this.undoStack = [this.editor.innerHTML]; this.redoStack = []; }
        pushState() { if (this.undoStack[this.undoStack.length - 1] !== this.editor.innerHTML) { this.undoStack.push(this.editor.innerHTML); this.redoStack = []; } }
        undo() { if (this.undoStack.length > 1) { this.redoStack.push(this.undoStack.pop()); this.editor.innerHTML = this.undoStack[this.undoStack.length - 1]; } }
        redo() { if (this.redoStack.length > 0) { const state = this.redoStack.pop(); this.undoStack.push(state); this.editor.innerHTML = state; } }
    }

    const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
    
    function generateRuler(editorWrapper) {
        const horizontalRuler = editorWrapper.querySelector('.ruler.horizontal'); const verticalRuler = editorWrapper.querySelector('.ruler.vertical');
        if (!horizontalRuler || !verticalRuler) return;
        horizontalRuler.innerHTML = ''; verticalRuler.innerHTML = '';
        const noteEditor = editorWrapper.querySelector('.note-editor');
        const editorWidth = noteEditor.scrollWidth; const editorHeight = noteEditor.scrollHeight;
        
        for (let i = 0; i < editorWidth; i += 10) {
            if (i % 50 === 0) {
                const mark = document.createElement('div'); mark.className = 'ruler-mark';
                mark.style.left = `${i}px`; mark.style.height = '10px'; if(i % 100 !== 0) mark.style.height = '5px';
                horizontalRuler.appendChild(mark);
                if (i % 100 === 0 && i > 0) { const num = document.createElement('span'); num.className = 'ruler-number'; num.textContent = i; num.style.left = `${i}px`; horizontalRuler.appendChild(num); }
            }
        }
        for (let i = 0; i < editorHeight; i += 10) {
            if (i % 50 === 0) {
                const mark = document.createElement('div'); mark.className = 'ruler-mark';
                mark.style.top = `${i}px`; mark.style.width = '10px'; if(i % 100 !== 0) mark.style.width = '5px';
                verticalRuler.appendChild(mark);
                if (i % 100 === 0 && i > 0) { const num = document.createElement('span'); num.className = 'ruler-number'; num.textContent = i; num.style.top = `${i}px`; verticalRuler.appendChild(num); }
            }
        }
    }

    function initializeEditor(editorElement, toolbarElement, imageInputElement, history) {
        // PERBAIKAN LINK: Variabel untuk popover dan status
        let savedRange = null;
        const linkPopover = document.getElementById('link-popover');
        const linkUrlInput = document.getElementById('link-url-input');
        const linkSaveBtn = document.getElementById('link-save-btn');
        const linkRemoveBtn = document.getElementById('link-remove-btn');
        
        const buildToolbar = () => {
            const tools = [
                { id: 'undo', icon: 'fa-undo', title: 'Urungkan' }, { id: 'redo', icon: 'fa-redo', title: 'Ulangi' }, { type: 'separator' },
                { id: 'removeFormat', icon: 'fa-eraser', title: 'Hapus Format' }, { type: 'separator' },
                { id: 'formatBlock-H1', value: 'H1', icon: 'fa-heading', title: 'Judul 1' }, { id: 'formatBlock-H2', value: 'H2', icon: 'fa-heading', title: 'Judul 2' }, { id: 'formatBlock-P', value: 'P', icon: 'fa-paragraph', title: 'Paragraf' },
                { id: 'formatBlock-BLOCKQUOTE', value: 'BLOCKQUOTE', icon: 'fa-quote-left', title: 'Kutipan' }, { type: 'separator' },
                { id: 'bold', icon: 'fa-bold', title: 'Tebal' }, { id: 'italic', icon: 'fa-italic', title: 'Miring' }, { id: 'underline', icon: 'fa-underline', title: 'Garis Bawah' }, { id: 'strikethrough', icon: 'fa-strikethrough', title: 'Coret' },
                { id: 'superscript', icon: 'fa-superscript', title: 'Superscript' }, { id: 'subscript', icon: 'fa-subscript', title: 'Subscript' }, { type: 'separator' },
                { id: 'foreColor', icon: 'fa-palette', type: 'color', title: 'Warna Teks' }, { id: 'backColor', icon: 'fa-highlighter', type: 'color', title: 'Stabilo' }, { type: 'separator' },
                { id: 'justifyLeft', icon: 'fa-align-left', title: 'Rata Kiri' }, { id: 'justifyCenter', icon: 'fa-align-center', title: 'Rata Tengah' }, { id: 'justifyRight', icon: 'fa-align-right', title: 'Rata Kanan' }, { type: 'separator' },
                { id: 'insertUnorderedList', icon: 'fa-list-ul', title: 'Daftar Poin' }, { id: 'insertOrderedList', icon: 'fa-list-ol', title: 'Daftar Angka' }, { id: 'wrapAsTask', icon: 'fa-check-square', title: 'Daftar Tugas' },
                { id: 'indent', icon: 'fa-indent', title: 'Tambah Indentasi' }, { id: 'outdent', icon: 'fa-outdent', title: 'Kurangi Indentasi' }, { type: 'separator' },
                { id: 'createLink', icon: 'fa-link', title: 'Buat/Ubah Tautan' }, { id: 'insertHorizontalRule', icon: 'fa-minus', title: 'Garis Horizontal' }, { id: 'image', icon: 'fa-image', title: 'Sisipkan Gambar' },
            ];
            toolbarElement.innerHTML = '';
            tools.forEach(tool => {
                if (tool.type === 'separator') { toolbarElement.innerHTML += '<div class="toolbar-separator"></div>'; return; }
                if (tool.type === 'color') {
                    const wrapper = document.createElement('div'); wrapper.className = 'color-picker-wrapper'; wrapper.title = tool.title;
                    wrapper.innerHTML = `<i class="fas ${tool.icon}"></i><input type="color">`;
                    const colorInput = wrapper.querySelector('input'); colorInput.addEventListener('input', () => executeCommand(tool.id, colorInput.value));
                    toolbarElement.appendChild(wrapper);
                } else {
                    const button = document.createElement('button'); button.title = tool.title; button.dataset.command = tool.id.split('-')[0];
                    if (tool.value) button.dataset.value = tool.value;
                    let content = `<i class="fas ${tool.icon}"></i>`;
                    if (tool.value && tool.id.includes('formatBlock') && tool.value.startsWith('H')) { content += `<span style="font-size: 0.7em; margin-left:2px; font-weight: 600;">${tool.value.replace('H', '')}</span>`; }
                    button.innerHTML = content; toolbarElement.appendChild(button);
                }
            });
        };
        buildToolbar();

        const executeCommand = (command, value = null) => { document.execCommand(command, false, value); history.pushState(); editorElement.focus(); };
        
        // PERBAIKAN LINK: Fungsi-fungsi helper untuk popover
        const getSelectionLink = () => {
            if (window.getSelection().rangeCount === 0) return null;
            let node = window.getSelection().getRangeAt(0).startContainer;
            node = node.nodeType === 3 ? node.parentNode : node;
            return node.closest('a');
        };
        const hideLinkPopover = () => { linkPopover.style.display = 'none'; savedRange = null; };
        const showLinkPopover = (targetButton) => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) savedRange = selection.getRangeAt(0).cloneRange();
            
            const rect = targetButton.getBoundingClientRect();
            linkPopover.style.display = 'flex';
            linkPopover.style.top = `${rect.bottom + 8}px`;
            linkPopover.style.left = `${Math.max(8, rect.left + rect.width / 2 - linkPopover.offsetWidth / 2)}px`;

            const existingLink = getSelectionLink();
            if (existingLink) {
                linkUrlInput.value = existingLink.getAttribute('href');
                linkRemoveBtn.style.display = 'flex';
            } else {
                linkUrlInput.value = '';
                linkRemoveBtn.style.display = 'none';
            }
            linkUrlInput.focus();
        };

        toolbarElement.addEventListener('click', e => {
            const button = e.target.closest('button'); if (!button) return;
            const { command, value } = button.dataset;

            // PERBAIKAN LINK: Ganti `prompt` dengan popover
            if (command === 'createLink') { showLinkPopover(button); }
            else if (command === 'image') { imageInputElement.click(); }
            else if (command === 'undo') { history.undo(); }
            else if (command === 'redo') { history.redo(); }
            else if (command === 'wrapAsTask') {
                const selection = window.getSelection(); if (!selection.rangeCount || selection.isCollapsed) return showToast('Pilih teks terlebih dahulu!', 'error');
                const range = selection.getRangeAt(0);
                if (range.startContainer.parentElement.closest('.task-item')) return showToast('Tidak bisa membuat tugas di dalam tugas lain.', 'error');
                const content = range.extractContents(); const taskItem = document.createElement('div');
                taskItem.className = 'task-item'; const checkbox = document.createElement('div');
                checkbox.className = 'task-item-checkbox'; checkbox.innerHTML = '<i class="fas fa-check"></i>';
                const textSpan = document.createElement('span'); textSpan.className = 'task-item-content';
                textSpan.setAttribute('contenteditable', 'true'); textSpan.appendChild(content);
                taskItem.appendChild(checkbox); taskItem.appendChild(textSpan); range.insertNode(taskItem);
                history.pushState();
            } else executeCommand(command, value);
        });

        // PERBAIKAN LINK: Event listener untuk tombol di popover
        linkSaveBtn.addEventListener('click', () => {
            if (!savedRange) return;
            const selection = window.getSelection();
            selection.removeAllRanges(); selection.addRange(savedRange);
            let url = linkUrlInput.value.trim();
            if (url) {
                if (!/^(https?:\/\/|mailto:|tel:)/i.test(url)) url = 'https://' + url;
                executeCommand('createLink', url);
            }
            hideLinkPopover();
        });
        linkRemoveBtn.addEventListener('click', () => {
            if (!savedRange) return;
            const selection = window.getSelection();
            selection.removeAllRanges(); selection.addRange(savedRange);
            executeCommand('unlink');
            hideLinkPopover();
        });
        document.addEventListener('click', (e) => {
            if (linkPopover.style.display === 'flex' && !linkPopover.contains(e.target) && !e.target.closest('[data-command="createLink"]')) {
                hideLinkPopover();
            }
        });
        
        imageInputElement.addEventListener('change', e => {
            const file = e.target.files[0]; if (!file) return; editorElement.focus();
            const reader = new FileReader();
            reader.onload = event => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); let { width, height } = img;
                    const MAX_WIDTH = 800, QUALITY = 0.7;
                    if (width > MAX_WIDTH) { height = (MAX_WIDTH / width) * height; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    executeCommand('insertHTML', `<p style="text-align: center;"><img src="${canvas.toDataURL('image/jpeg', QUALITY)}"></p>`);
                };
            };
            reader.readAsDataURL(file); e.target.value = '';
        });
        
        editorElement.addEventListener('click', e => { if (e.target.classList.contains('task-item-checkbox')) { e.target.parentElement.classList.toggle('completed'); history.pushState(); } });
        
        editorElement.addEventListener('keydown', e => {
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.isCollapsed) return;
            if (e.key === 'Backspace') {
                const range = selection.getRangeAt(0); const container = range.startContainer;
                const taskContent = (container.nodeType === 3 ? container.parentElement : container).closest('.task-item-content');
                if (taskContent) {
                    const startRange = document.createRange(); startRange.selectNodeContents(taskContent);
                    startRange.collapse(true);
                    if (range.compareBoundaryPoints(Range.START_TO_START, startRange) === 0) {
                        const taskItem = taskContent.closest('.task-item');
                        if (taskItem) { e.preventDefault(); taskItem.remove(); history.pushState(); }
                    }
                }
            }
        });

        editorElement.addEventListener('keyup', debounce(() => history.pushState(), 500));
        
        const updateToolbarState = () => {
            toolbarElement.querySelectorAll('button').forEach(btn => {
                try {
                    const { command } = btn.dataset;
                    let isActive = false;
                    // PERBAIKAN LINK: Buat tombol aktif jika di dalam tautan
                    if (command === 'createLink') isActive = !!getSelectionLink();
                    else if (command && !command.includes('formatBlock')) isActive = document.queryCommandState(command);
                    if (isActive) btn.classList.add('active'); else btn.classList.remove('active');
                } catch (error) { btn.classList.remove('active'); }
            });
        };
        document.addEventListener('selectionchange', () => { if (document.activeElement === editorElement) updateToolbarState(); });
    }
    
    function filterAndRenderNotesList() {
        const container = document.getElementById('notes-list-container');
        const searchInput = document.getElementById('search-notes-input');
        const searchText = searchInput.value.toLowerCase();
        
        container.innerHTML = '';
        if (userNotesCache.length === 0) { container.innerHTML = '<p style="text-align:center; color: var(--text-muted); padding-top: 2rem;">Mulai buat catatan pertamamu!</p>'; return; }

        const filteredNotes = userNotesCache.filter(note => {
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = note.content;
            const noteText = tempDiv.textContent.toLowerCase();
            return noteText.includes(searchText);
        });

        if (filteredNotes.length === 0) { container.innerHTML = '<p style="text-align:center; color: var(--text-muted); padding-top: 2rem;">Tidak ada catatan yang cocok dengan pencarian.</p>'; return; }

        filteredNotes.forEach(note => {
            const div = document.createElement('div'); div.innerHTML = note.content;
            const hasCompletedTasks = div.querySelector('.task-item.completed') !== null;
            const titleText = div.textContent.substring(0, 100).trim().split('\n')[0] || 'Catatan tanpa judul';
            const item = document.createElement('div'); item.className = 'note-item-selector';
            if (hasCompletedTasks) item.classList.add('has-completed-tasks');
            item.dataset.noteId = note.id;

            const highlightedTitle = searchText ? titleText.replace(new RegExp(searchText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), match => `<mark>${match}</mark>`) : titleText;
            item.innerHTML = `<span class="title">${highlightedTitle}</span><button class="delete-note-btn" title="Hapus"><i class="fas fa-trash"></i></button>`;
            container.appendChild(item);
        });
    }

    async function loadNotesList() {
        if (!loggedInUser) return;
        const db = await readBin(USER_NOTES_BIN_ID);
        const userEntry = (db.user || []).find(u => u.userId === loggedInUser.id);
        userNotesCache = userEntry ? userEntry.notes : [];
        userNotesCache.sort((a, b) => parseInt(b.id.split('_')[1] || 0) - parseInt(a.id.split('_')[1] || 0));
        filterAndRenderNotesList();
    }

    async function loadNoteContent(noteId, editorElement, history) {
        const note = (userNotesCache || []).find(n => n.id === noteId);
        if (note) { editorElement.innerHTML = note.content; currentEditingNoteId = note.id; history.init(); generateRuler(editorElement.parentElement); }
    }

    async function savePersonalNote() {
        const content = document.getElementById('note-editor').innerHTML.trim();
        if (!content) return showToast('Catatan tidak boleh kosong!', 'error');
        const db = await readBin(USER_NOTES_BIN_ID);
        const allUserNotes = db.user || [];
        let userNotesEntry = allUserNotes.find(u => u.userId === loggedInUser.id);
        if (!userNotesEntry) { userNotesEntry = { userId: loggedInUser.id, notes: [] }; allUserNotes.push(userNotesEntry); }
        const noteIndex = userNotesEntry.notes.findIndex(n => n.id === currentEditingNoteId);
        if (noteIndex > -1) { userNotesEntry.notes[noteIndex].content = content; }
        else { const newNote = { id: `note_${Date.now()}`, content }; userNotesEntry.notes.push(newNote); currentEditingNoteId = newNote.id; }
        const result = await updateBin(USER_NOTES_BIN_ID, { user: allUserNotes });
        if (result) { showToast('Catatan berhasil disimpan!'); await loadNotesList(); }
    }

    async function deleteNote(noteId) {
        if (!(await showConfirm('Hapus Catatan', 'Apakah Anda yakin ingin menghapus catatan ini secara permanen?'))) return;
        const db = await readBin(USER_NOTES_BIN_ID);
        let userNotesEntry = (db.user || []).find(u => u.userId === loggedInUser.id);
        if (userNotesEntry) {
            userNotesEntry.notes = userNotesEntry.notes.filter(n => n.id !== noteId);
            const result = await updateBin(USER_NOTES_BIN_ID, { user: db.user });
            if (result) { showToast('Catatan dihapus.'); if (currentEditingNoteId === noteId) document.getElementById('btn-new-note').click(); await loadNotesList(); }
        }
    }

    async function loadServerNote(history) {
        const db = await readBin(SERVER_NOTES_BIN_ID);
        const content = db.server_data_note || "";
        const serverNoteContainer = document.getElementById('server-note-content');
        serverNoteContainer.innerHTML = content;
        if (loggedInUser.role === 'admin' && history) { history.init(); generateRuler(serverNoteContainer.parentElement); }
    }

    async function saveServerNote() {
        const content = document.getElementById('server-note-content').innerHTML.trim();
        const result = await updateBin(SERVER_NOTES_BIN_ID, { server_data_note: content });
        if (result) showToast('Pengumuman Harian berhasil diperbarui!');
    }

    function initializeApp() {
        loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser) return;

        const personalEditor = document.getElementById('note-editor');
        const personalToolbar = document.getElementById('personal-toolbar');
        const personalImageInput = document.getElementById('image-input');
        const personalHistory = new EditorHistory(personalEditor);
        initializeEditor(personalEditor, personalToolbar, personalImageInput, personalHistory);
        
        const personalEditorWrapper = document.getElementById('personal-editor-wrapper');
        const debouncedPersonalRulerUpdate = debounce(() => generateRuler(personalEditorWrapper), 150);
        const personalResizeObserver = new ResizeObserver(debouncedPersonalRulerUpdate);
        personalResizeObserver.observe(personalEditor);
        debouncedPersonalRulerUpdate();

        const serverEditor = document.getElementById('server-note-content');
        let serverHistory = null;
        if (loggedInUser.role === 'admin') {
            const serverToolbar = document.getElementById('server-toolbar');
            const serverImageInput = document.getElementById('server-image-input');
            serverHistory = new EditorHistory(serverEditor);
            initializeEditor(serverEditor, serverToolbar, serverImageInput, serverHistory);
            document.getElementById('save-server-note-btn').addEventListener('click', saveServerNote);
            const serverEditorWrapper = document.getElementById('server-editor-wrapper');
            const debouncedServerRulerUpdate = debounce(() => generateRuler(serverEditorWrapper), 150);
            const serverResizeObserver = new ResizeObserver(debouncedServerRulerUpdate);
            serverResizeObserver.observe(serverEditor);
        }

        document.getElementById('save-note-btn').addEventListener('click', savePersonalNote);
        document.getElementById('btn-new-note').addEventListener('click', () => {
            currentEditingNoteId = null; personalEditor.innerHTML = '';
            personalHistory.init(); personalEditor.focus();
            generateRuler(personalEditorWrapper);
        });
        
        document.getElementById('notes-list-container').addEventListener('click', e => {
            const item = e.target.closest('.note-item-selector');
            if (!item) return;
            if (e.target.closest('.delete-note-btn')) { e.stopPropagation(); deleteNote(item.dataset.noteId); }
            else { loadNoteContent(item.dataset.noteId, personalEditor, personalHistory); document.querySelector('.nav-item[data-page="personal-notes-page"]').click(); }
        });

        document.getElementById('btn-daily-note').addEventListener('click', async () => {
            const dateString = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const dailyNoteIdentifier = `<h1>Catatan Harian: ${dateString}</h1>`;
            const existingNote = userNotesCache.find(note => note.content.includes(dailyNoteIdentifier));
            if (existingNote) { await loadNoteContent(existingNote.id, personalEditor, personalHistory); showToast(`Membuka catatan untuk ${dateString}`); }
            else { currentEditingNoteId = null; personalEditor.innerHTML = `${dailyNoteIdentifier}<p><br></p>`; personalHistory.init(); personalEditor.focus(); showToast(`Membuat catatan baru untuk ${dateString}`); }
            generateRuler(personalEditorWrapper);
        });
        
        loadServerNote(serverHistory);
        loadNotesList();
    }
    
    // ================== KODE DARI: dashboard.js ==================
    function main() {
        loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            document.getElementById('auth-wrapper').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';

            const showLoginBtn = document.getElementById('show-login');
            const showRegisterBtn = document.getElementById('show-register');
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');

            showRegisterBtn.addEventListener('click', () => { loginView.style.display = 'none'; registerView.style.display = 'block'; });
            showLoginBtn.addEventListener('click', () => { registerView.style.display = 'none'; loginView.style.display = 'block'; });
            
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value.trim(); const password = document.getElementById('password').value;
                    if (!username || !password) return showToast('User ID dan Password tidak boleh kosong!', 'error');
                    const db = await readBin(DATA_USER_BIN_ID);
                    const user = (db.data_user || []).find(u => u.username === username && u.password === password);
                    if (user) {
                        localStorage.setItem('loggedInUser', JSON.stringify({ id: user.id, username: user.username, role: user.role }));
                        showToast(`Selamat datang kembali, ${user.username}!`);
                        document.body.classList.add('page-fade-out');
                        setTimeout(() => window.location.reload(), 300);
                    } else { showToast('User ID atau Password salah.', 'error'); }
                });
            }
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('new-username').value.trim(); const password = document.getElementById('new-password').value;
                    if (!username || !password) return showToast('User ID dan Password tidak boleh kosong!', 'error');
                    let db = await readBin(DATA_USER_BIN_ID);
                    const userList = db.data_user || [];
                    if (userList.some(user => user.username === username)) return showToast('User ID sudah digunakan.', 'error');
                    userList.push({ id: `user_${Date.now()}`, username, password, role: 'user' });
                    const result = await updateBin(DATA_USER_BIN_ID, { data_user: userList });
                    if (result) { showToast('Akun berhasil dibuat! Silakan login.'); showLoginBtn.click(); }
                });
            }

        } else {
            document.getElementById('auth-wrapper').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            const pages = document.querySelectorAll('.app-page');
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const pageId = e.currentTarget.dataset.page;
                    if (pageId) {
                        pages.forEach(page => page.classList.remove('active-page'));
                        document.getElementById(pageId).classList.add('active-page');
                        navItems.forEach(nav => nav.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                    }
                });
            });

            document.getElementById('logout-btn-nav').addEventListener('click', async () => {
                if (await showConfirm('Konfirmasi Logout', 'Anda yakin ingin keluar dari sesi ini?')) {
                    localStorage.removeItem('loggedInUser');
                    document.body.classList.add('page-fade-out');
                    setTimeout(() => window.location.reload(), 300);
                }
            });

            const taskFilterBtn = document.getElementById('task-filter-btn');
            taskFilterBtn.addEventListener('click', () => {
                const listContainer = document.getElementById('notes-list-container');
                listContainer.classList.toggle('notes-filtered'); taskFilterBtn.classList.toggle('active');
                showToast(listContainer.classList.contains('notes-filtered') ? 'Menyembunyikan catatan dengan tugas selesai' : 'Menampilkan semua catatan');
            });

            document.getElementById('search-notes-input').addEventListener('input', debounce(filterAndRenderNotesList, 300));

            if (loggedInUser.role === 'admin') {
                document.getElementById('server-note-content').contentEditable = true;
                document.getElementById('server-header-actions').style.display = 'flex';
                document.getElementById('server-toolbar').style.display = 'flex';
                document.getElementById('server-editor-wrapper').classList.add('ruler-active');
            } else {
                const serverEditorWrapper = document.getElementById('server-editor-wrapper');
                if (serverEditorWrapper) serverEditorWrapper.classList.remove('ruler-active');
                
                const serverNoteContainer = document.getElementById('server-note-content');
                if(serverNoteContainer){
                    serverNoteContainer.addEventListener('beforeinput', e => {
                        e.preventDefault();
                    });
                }
            }
            
            initializeApp();
        }
    }
    
    document.addEventListener('DOMContentLoaded', main);
    
    //]]>
    </script>
</body>
</html>